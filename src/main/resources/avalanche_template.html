<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Avalanche Reports</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
          font-family: Arial, sans-serif;
          background: #f5f7fa;
          margin: 0;
          padding: 20px;
        }

        h1 {
          text-align: center;
        }

        .container {
          max-width: 900px;
          margin: auto;
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #navigation {
          text-align: center;
          margin-top: 10px;
        }

        #navigation button {
          margin: 0 10px;
          padding: 8px 16px;
          font-size: 14px;
        }

        #commentBox {
          margin-top: 20px;
          padding: 15px;
          border-left: 4px solid #0077cc;
          background: #f0f6ff;
          display: none;
        }

        #commentBox h3 {
          margin-top: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Avalanche Danger Levels</h1>

    <canvas id="avalancheChart"></canvas>

    <div id="navigation">
        <button id="prevPage">Previous</button>
        <button id="nextPage" disabled>Next</button>
    </div>

    <div id="commentBox">
        <h3 id="commentDate"></h3>
        <p id="commentText"></p>
        <small id="commentMeta"></small>
    </div>
</div>

<script>
    const API_URL = "reports";
    let currentPage = 0;
    const pageSize = 20; // default size

    let currentChartInstance = null; // To keep track of the Chart instance

    function updateButtons() {
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');

      // Next is disabled if we are at the most current page (currentPage === 0)
      nextBtn.disabled = (currentPage === 0);

      // Previous is disabled only if we reached the oldest page (if you know totalPagesBack)
      // For now, assume it's always enabled
      prevBtn.disabled = false;
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      return d.toISOString().substring(0, 10);
    }

    function getColorByLevel(level) {
      if (level <= 1) return "green";
      if (level == 2) return "yellow";
      if (level == 3) return "orange";
      if (level >= 4) return "red";
      return "gray"; // fallback
    }

    async function loadReports(page = 0) {
      try {
        const response = await fetch(`${API_URL}?size=${pageSize}&page=${page}`);
        const data = await response.json();

        // sort by date ascending
        data.sort((a, b) => new Date(a.reportExpirationDate) - new Date(b.reportExpirationDate));

        // store globally for access in click handler
        window.currentReports = data;

        // Destroy previous chart if exists
        if (currentChartInstance) {
          currentChartInstance.destroy();
        }

        // create chart with new data
        createChart(data);

        // update current page
        currentPage = page;
        updateButtons();
      } catch (err) {
        console.error(err);
        alert("Failed to load avalanche reports");
      }
    }

    function createChart(reports) {
      const labels = reports.map(r => formatDate(r.reportExpirationDate));
      const levels = reports.map(r => r.avalancheLevel);
      const barColors = levels.map(level => getColorByLevel(level));

      const ctx = document.getElementById("avalancheChart").getContext("2d");

      currentChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Avalanche Level",
            data: levels,
            backgroundColor: barColors
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              min: 0,
              max: 5,
              ticks: {
                stepSize: 1
              },
              title: {
                display: true,
                text: "Danger Level"
              }
            }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              showComment(reports[index]);
            }
          }
        }
      });
    }

    function showComment(report) {
      document.getElementById("commentBox").style.display = "block";
      document.getElementById("commentDate").textContent =
        "Report for " + formatDate(report.reportExpirationDate);
      document.getElementById("commentText").textContent = report.comment;
      document.getElementById("commentMeta").textContent =
        `Reported by ${report.reportedBy}, at ${report.reportDate}, valid until ${report.reportExpirationDate}`;
    }

    // Button event handlers
    document.getElementById('prevPage').addEventListener('click', () => {
      loadReports(currentPage + 1); // older data
    });

    document.getElementById('nextPage').addEventListener('click', () => {
      loadReports(currentPage - 1); // newer data
    });

    // Initialize
    window.onload = () => {
      updateButtons();
      loadReports(0);
    };
</script>

</body>
</html>